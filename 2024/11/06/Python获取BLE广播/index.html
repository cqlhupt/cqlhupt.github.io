<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Python获取BLE广播 - Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Jhon Tony"><meta name="msapplication-TileImage" content="/img/xuancailizi.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jhon Tony"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="蓝牙协议从1999年发布第一版以来已经二十几个年头，也随着移动通信的发展普及到我们生活的方方面面，并且在可见的未来将会随着物联网和边缘计算渗透到我们肉眼可见不可见的各个角落。在蓝牙4.0中，蓝牙技术联盟（Bluetooth SIG）引入了BLE（Bluetooth Low Energy）协议，该协议以极低的功耗优势进入物联网设备领域。本篇就一起看一下，如何在Windows使用Python读取周围B"><meta property="og:type" content="blog"><meta property="og:title" content="Python获取BLE广播"><meta property="og:url" content="https://cqlhupt.github.io/2024/11/06/Python%E8%8E%B7%E5%8F%96BLE%E5%B9%BF%E6%92%AD/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="蓝牙协议从1999年发布第一版以来已经二十几个年头，也随着移动通信的发展普及到我们生活的方方面面，并且在可见的未来将会随着物联网和边缘计算渗透到我们肉眼可见不可见的各个角落。在蓝牙4.0中，蓝牙技术联盟（Bluetooth SIG）引入了BLE（Bluetooth Low Energy）协议，该协议以极低的功耗优势进入物联网设备领域。本篇就一起看一下，如何在Windows使用Python读取周围B"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/nRF_connect_startup.jpg"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/nRF_connect_scan.jpg"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/nRF_connect_advertisement.jpg"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/nRF_connect_advertisement_raw.jpg"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/microsoft_cpp_dependency.png"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/bleak_AdvertisementData_classs.png"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/bleak_valid_assigned_numbers.png"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/bleak_get_adv_issue.png"><meta property="og:image" content="https://cqlhupt.github.io/img/python_ble/BluetoothLEAdvertisement_class.png"><meta property="article:published_time" content="2024-11-06T13:10:28.000Z"><meta property="article:modified_time" content="2024-11-09T05:20:50.420Z"><meta property="article:author" content="John Tony"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/python_ble/nRF_connect_startup.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqlhupt.github.io/2024/11/06/Python%E8%8E%B7%E5%8F%96BLE%E5%B9%BF%E6%92%AD/"},"headline":"Python获取BLE广播","image":["https://cqlhupt.github.io/img/python_ble/nRF_connect_startup.jpg","https://cqlhupt.github.io/img/python_ble/nRF_connect_scan.jpg","https://cqlhupt.github.io/img/python_ble/nRF_connect_advertisement.jpg","https://cqlhupt.github.io/img/python_ble/nRF_connect_advertisement_raw.jpg","https://cqlhupt.github.io/img/python_ble/microsoft_cpp_dependency.png","https://cqlhupt.github.io/img/python_ble/bleak_AdvertisementData_classs.png","https://cqlhupt.github.io/img/python_ble/bleak_valid_assigned_numbers.png","https://cqlhupt.github.io/img/python_ble/bleak_get_adv_issue.png","https://cqlhupt.github.io/img/python_ble/BluetoothLEAdvertisement_class.png"],"datePublished":"2024-11-06T13:10:28.000Z","dateModified":"2024-11-09T05:20:50.420Z","author":{"@type":"Person","name":"John Tony"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"https://cqlhupt.github.io/img/logo.svg"}},"description":"蓝牙协议从1999年发布第一版以来已经二十几个年头，也随着移动通信的发展普及到我们生活的方方面面，并且在可见的未来将会随着物联网和边缘计算渗透到我们肉眼可见不可见的各个角落。在蓝牙4.0中，蓝牙技术联盟（Bluetooth SIG）引入了BLE（Bluetooth Low Energy）协议，该协议以极低的功耗优势进入物联网设备领域。本篇就一起看一下，如何在Windows使用Python读取周围B"}</script><link rel="canonical" href="https://cqlhupt.github.io/2024/11/06/Python%E8%8E%B7%E5%8F%96BLE%E5%B9%BF%E6%92%AD/"><link rel="icon" href="/img/xuancailizi.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-11-06T13:10:28.000Z" title="2024/11/6 21:10:28">2024-11-06</time>发表</span><span class="level-item"><time dateTime="2024-11-09T05:20:50.420Z" title="2024/11/9 13:20:50">2024-11-09</time>更新</span><span class="level-item">27 分钟读完 (大约4116个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Python获取BLE广播</h1><div class="content"><p>蓝牙协议从1999年发布第一版以来已经二十几个年头，也随着移动通信的发展普及到我们生活的方方面面，并且在可见的未来将会随着物联网和边缘计算渗透到我们肉眼可见不可见的各个角落。在蓝牙4.0中，<a target="_blank" rel="noopener" href="https://www.bluetooth.com/zh-cn/">蓝牙技术联盟（Bluetooth SIG）</a>引入了BLE（Bluetooth Low Energy）协议，该协议以极低的功耗优势进入物联网设备领域。本篇就一起看一下，如何在Windows使用Python读取周围BLE设备发出的广播（advertisement）。</p>
<span id="more"></span>
<h1 id="nRF-Connect"><a href="#nRF-Connect" class="headerlink" title="nRF Connect"></a>nRF Connect</h1><p>如果你调试过BLE设备，那么nRF Connect软件你应该并不陌生，它是由<a target="_blank" rel="noopener" href="https://www.nordicsemi.com/">NORDIC SEMICONDUCTOR</a>公司开发的一款跨平台BLE连接性测试应用。他们也设计各种射频相关的Soc，你可以购买他们的评估或者开发套件用于测试与开发。</p>
<p>通过移动版的nRF Connect应用可以轻松的对附近的蓝牙设备进行扫描，并且不依赖于任何外部硬件设备。如果你使用的是Android设备，你可以前往<a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp&hl=en&gl=US">Google Play</a>或者<a target="_blank" rel="noopener" href="https://github.com/NordicSemiconductor/Android-nRF-Connect/releases">Github</a>下载相应的安装包文件进行安装，如果你使用的是苹果设备请前往<a target="_blank" rel="noopener" href="https://apps.apple.com/gb/app/nrf-connect-for-mobile/id1054362403">App Store</a>下载应用。</p>
<p>nRF Connect应用启动页面如下，软件需要打开定位和蓝牙方可开始扫描</p>
<p><img src="/img/python_ble/nRF_connect_startup.jpg" alt="nRF Connect首页" title="nRF Connect首页"></p>
<p>我们打开定位和蓝牙就可以看到右上角的SCAN按钮，然后点击按钮即可对周围的蓝牙设备进行扫描</p>
<p><img src="/img/python_ble/nRF_connect_scan.jpg" alt="nRF Connect扫描设备" title="nRF Connect扫描设备"></p>
<p>点击设备列表中的设备可以展开查看设备的广播信息</p>
<p><img src="/img/python_ble/nRF_connect_advertisement.jpg" alt="nRF Connect广播信息" title="nRF Connect广播信息"></p>
<p>点击信息的RAW按钮，即可查看该设备广播的RAW数据是什么</p>
<p><img src="/img/python_ble/nRF_connect_advertisement_raw.jpg" alt="nRF Connect广播RAW" title="nRF Connect广播RAW"></p>
<p>Raw data解析之后就是Details表格中的内容，实际上raw data的组织是很简单的，raw data是按照多个固定顺序排列的数据结构构成的：<br></p>
<ul>
<li>第1字节是type和value的字节数量</li>
<li>第2字节是type，是蓝牙技术联盟指定的内容类型</li>
<li>后续字节是value，即数据载荷</li>
</ul>
<p>重复以上数据结构，即组成raw data，我们也可以根据规则对raw data进行解析，这个我们后续会用到。</p>
<p>nRF Connect的功能非常强大，不过今天不准备再介绍它了。nRF Connect虽然功能强大，不过目前较为普遍的使用都是手机端的，桌面端的需要一个他们公司的适配器才能进行周围的设备扫描，另外一个缺点是手机端应用需要开启定位，虽然我也不知道它为什么要定位，不过对于需要定位的应用我总是觉得不是很放心。所以接下来我们开始介绍Python的蓝牙库，最终实现在Windows上直接获取BLE的RAW广播。</p>
<h1 id="Python的蓝牙库"><a href="#Python的蓝牙库" class="headerlink" title="Python的蓝牙库"></a>Python的蓝牙库</h1><p>如果你希望使用Python实现某个功能，那么你要先寻找一个相应的库，然后在代码中引入这个库。接下来我们看一下各位大神都给我们造好了哪些轮子吧。</p>
<h2 id="pybluez"><a href="#pybluez" class="headerlink" title="pybluez"></a>pybluez</h2><p>pybluez支持Windows和Linux下的经典蓝牙，仅在Linux下支持BLE。由于不同操作系统对于硬件的驱动方式不同，所以一个处于高层的库需要更底层的库依赖，或者对底层的库进行封装。你可以前往<a target="_blank" rel="noopener" href="https://pybluez.readthedocs.io/en/latest/install.html">PyBluez官方文档</a>查看如何进行安装。</p>
<p>pybluez的安装相当麻烦，在windows上需要安装<a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk">Microsoft Visual C++ 14.0</a>，这个其实我难以理解，为什么某些操作系统上层的应用会以操作系统的应用开发工具为依赖，这种依赖方式在你安装了各种不同的应用之后会发现你的程序管理器中多出一大堆不同版本的Microsoft Visual C++，有些应用甚至直接让你安装一个Microsoft Visual Studio开发环境，如果你遇到不同应用之间的依赖版本冲突则堪称噩梦，因为此时你虽然只想把当前这个应用安装好，但是你必须弄清楚以前安装的应用的依赖分别是哪些，以及会不会有版本冲突。</p>
<p><img src="/img/python_ble/microsoft_cpp_dependency.png" alt="不同版本的Microsoft Visual C++依赖" title="不同版本的Microsoft Visual C++依赖"></p>
<p>安装完成后我们可以使用如下代码进行测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server端</span></span><br><span class="line"><span class="keyword">from</span> bluetooth <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">server_sock=BluetoothSocket( RFCOMM )</span><br><span class="line">server_sock.bind((<span class="string">&quot;&quot;</span>,PORT_ANY))</span><br><span class="line">server_sock.listen(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">port = server_sock.getsockname()[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">uuid = <span class="string">&quot;94f39d29-7d6d-437d-973b-fba39e49d4ee&quot;</span></span><br><span class="line"></span><br><span class="line">advertise_service( server_sock, <span class="string">&quot;SampleServer&quot;</span>,</span><br><span class="line">                   service_id = uuid,</span><br><span class="line">                   service_classes = [ uuid, SERIAL_PORT_CLASS ],</span><br><span class="line">                   profiles = [ SERIAL_PORT_PROFILE ], </span><br><span class="line"><span class="comment">#                   protocols = [ OBEX_UUID ] </span></span><br><span class="line">                    )</span><br><span class="line">                   </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Waiting for connection on RFCOMM channel %d&quot;</span> % port)</span><br><span class="line"></span><br><span class="line">client_sock, client_info = server_sock.accept()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accepted connection from &quot;</span>, client_info)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = client_sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;received [%s]&quot;</span> % data)</span><br><span class="line"><span class="keyword">except</span> IOError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;disconnected&quot;</span>)</span><br><span class="line"></span><br><span class="line">client_sock.close()</span><br><span class="line">server_sock.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client端</span></span><br><span class="line"><span class="keyword">from</span> bluetooth <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version &lt; <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">    <span class="built_in">input</span> = raw_input</span><br><span class="line"></span><br><span class="line">addr = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no device specified.  Searching all nearby bluetooth devices for&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;the SampleServer service&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    addr = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Searching for SampleServer on %s&quot;</span> % addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># search for the SampleServer service</span></span><br><span class="line">uuid = <span class="string">&quot;94f39d29-7d6d-437d-973b-fba39e49d4ee&quot;</span></span><br><span class="line">service_matches = find_service( uuid = uuid, address = addr )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(service_matches) == <span class="number">0</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;couldn&#x27;t find the SampleServer service =(&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">first_match = service_matches[<span class="number">0</span>]</span><br><span class="line">port = first_match[<span class="string">&quot;port&quot;</span>]</span><br><span class="line">name = first_match[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">host = first_match[<span class="string">&quot;host&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;connecting to \&quot;%s\&quot; on %s&quot;</span> % (name, host))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the client socket</span></span><br><span class="line">sock=BluetoothSocket( RFCOMM )</span><br><span class="line">sock.connect((host, port))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;connected.  type stuff&quot;</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = <span class="built_in">input</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    sock.send(data)</span><br><span class="line"></span><br><span class="line">sock.close()</span><br></pre></td></tr></table></figure>

<h2 id="bluepy"><a href="#bluepy" class="headerlink" title="bluepy"></a>bluepy</h2><p>仅支持Linux的BLE蓝牙库，不需要底层操作系统依赖，直接通过pip安装即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install bluepy</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://ianharvey.github.io/bluepy-doc/">官方文档</a>中有一些DEMO可以参考，也可以参考<a target="_blank" rel="noopener" href="https://github.com/rlangoy/bluepy_examples_nRF51822_mbed">bluepy_examples_nRF51822_mbed</a></p>
<p>有一点需要注意，在Linux下使用bluepy要使用sudo前缀，由于bluepy只支持Linux，所以先不做介绍。</p>
<h2 id="bleak"><a href="#bleak" class="headerlink" title="bleak"></a>bleak</h2><p>来到本篇的重点，bleak是一个异步的BLE库，支持Windows和Linux，也不依赖任何Windows开发环境，直接依赖于Windows提供的Runtime环境。</p>
<p>直接通过pip安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install bleak</span><br></pre></td></tr></table></figure>

<p>直接扫描周围的BLE设备</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> bleak <span class="keyword">import</span> BleakScanner</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    devices = <span class="keyword">await</span> BleakScanner.discover()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> devices:</span><br><span class="line">        <span class="built_in">print</span>(d)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>使用client类连接设备进行操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> bleak <span class="keyword">import</span> BleakClient</span><br><span class="line"></span><br><span class="line">address = <span class="string">&quot;24:71:89:cc:09:05&quot;</span></span><br><span class="line">MODEL_NBR_UUID = <span class="string">&quot;2A24&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">address</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> BleakClient(address) <span class="keyword">as</span> client:</span><br><span class="line">        model_number = <span class="keyword">await</span> client.read_gatt_char(MODEL_NBR_UUID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Model Number: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot;&quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>, model_number))))</span><br><span class="line"></span><br><span class="line">asyncio.run(main(address))</span><br></pre></td></tr></table></figure>
<p>如果你想获取一些广播中的信息，你可以在discover方法中传入一个参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devices = <span class="keyword">await</span> scanner.discover(return_adv=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>将return_adv参数设为True之后，discover将会返回一个Dictionary，其key是蓝牙设备的地址字符串，其value是一个Tuple，该Tuple包含两个对象，第0个对象是BLEDevice，第1个对象是AdvertisementData，也许你觉得到此我们就可以获取到地址对应的广播数据了（advertisement），但是bleak的作者告诉我，并不能。</p>
<p>我们可以先看一下python安装目录\Lib\site-packages目录中的bleak的AdvertisementData类</p>
<p><img src="/img/python_ble/bleak_AdvertisementData_classs.png" alt="AdvertisementData类" title="AdvertisementData类"></p>
<p>观察类的内部属性，对比蓝牙技术联盟提供的<a target="_blank" rel="noopener" href="https://www.bluetooth.com/wp-content/uploads/Files/Specification/HTML/Assigned_Numbers/out/en/Assigned_Numbers.pdf?v=1731073793951">Assigned Numbers文档2.3节</a>，发现该类中的属性是将部分重要的Assigned Numbers对应的数据。我们还可以在目录中找到一个assigned_numbers.py文件，这里面就是bleak可以解析的Assigned Numbers</p>
<p><img src="/img/python_ble/bleak_valid_assigned_numbers.png" alt="bleak支持解析的Assigned Numbers" title="bleak支持解析的Assigned Numbers"></p>
<p>可以发现，bleak支持解析的Assigned Numbers其实很少，如果我们直接通过AdvertisementData类获取advertisement，就可能会出现bleak不支持的类型无法获取的问题，如下是目前较为完整的Assigned Numbers列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">adv_type_list = &#123;<span class="number">0x01</span>,<span class="number">0x02</span>,<span class="number">0x03</span>,<span class="number">0x04</span>,<span class="number">0x05</span>,<span class="number">0x06</span>,<span class="number">0x07</span>,<span class="number">0x08</span>,<span class="number">0x09</span>,<span class="number">0x0A</span></span><br><span class="line">                ,<span class="number">0x0D</span>,<span class="number">0x0E</span>,<span class="number">0x0F</span>,<span class="number">0x10</span>,<span class="number">0x11</span>,<span class="number">0x12</span>,<span class="number">0x14</span>,<span class="number">0x15</span>,<span class="number">0x16</span>,<span class="number">0x17</span></span><br><span class="line">                ,<span class="number">0x18</span>,<span class="number">0x19</span>,<span class="number">0x1A</span>,<span class="number">0x1B</span>,<span class="number">0x1C</span>,<span class="number">0x1D</span>,<span class="number">0x1E</span>,<span class="number">0x1F</span>,<span class="number">0x20</span>,<span class="number">0x21</span></span><br><span class="line">                ,<span class="number">0x22</span>,<span class="number">0x23</span>,<span class="number">0x24</span>,<span class="number">0x25</span>,<span class="number">0x26</span>,<span class="number">0x27</span>,<span class="number">0x28</span>,<span class="number">0x29</span>,<span class="number">0x2A</span>,<span class="number">0x2B</span></span><br><span class="line">                ,<span class="number">0x2C</span>,<span class="number">0x2D</span>,<span class="number">0x2E</span>,<span class="number">0x2F</span>,<span class="number">0x30</span>,<span class="number">0x31</span>,<span class="number">0x32</span>,<span class="number">0x34</span>,<span class="number">0x3D</span>,<span class="number">0xFF</span>&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们如何才能获取到完整的广播呢，不如直接到Github上提个issue问一下吧，看看作者如何解答：<a target="_blank" rel="noopener" href="https://github.com/hbldh/bleak/issues/1678">bleak&#x2F;issues&#x2F;1678</a></p>
<p><img src="/img/python_ble/bleak_get_adv_issue.png" alt="bleak作者如是说" title="bleak作者如是说"></p>
<p>非常遗憾，bleak并不提供这样的接口，不如来看看bleak是如何解析Windows返回的advertisement的吧。打开bleak\backends\winrt\scanner.py文件，找到BleakScannerWinRT类中的_received_handler方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_received_handler</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self,</span></span><br><span class="line"><span class="params">    sender: BluetoothLEAdvertisementWatcher,</span></span><br><span class="line"><span class="params">    event_args: BluetoothLEAdvertisementReceivedEventArgs,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Callback for AdvertisementWatcher.Received&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> Cannot check for if sender == self.watcher in winrt?</span></span><br><span class="line">    logger.debug(<span class="string">&quot;Received %s.&quot;</span>, _format_event_args(event_args))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># REVISIT: if scanning filters with BluetoothSignalStrengthFilter.OutOfRangeTimeout</span></span><br><span class="line">    <span class="comment"># are in place, an RSSI of -127 means that the device has gone out of range and should</span></span><br><span class="line">    <span class="comment"># be removed from the list of seen devices instead of processing the advertisement data.</span></span><br><span class="line">    <span class="comment"># https://learn.microsoft.com/en-us/uwp/api/windows.devices.bluetooth.bluetoothsignalstrengthfilter.outofrangetimeout</span></span><br><span class="line"></span><br><span class="line">    bdaddr = _format_bdaddr(event_args.bluetooth_address)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Unlike other platforms, Windows does not combine advertising data for</span></span><br><span class="line">    <span class="comment"># us (regular advertisement + scan response) so we have to do it manually.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the previous advertising data/scan response pair or start a new one</span></span><br><span class="line">    raw_data = <span class="variable language_">self</span>._advertisement_pairs.get(bdaddr, _RawAdvData(<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># update the advertising data depending on the advertising data type</span></span><br><span class="line">    <span class="keyword">if</span> event_args.advertisement_type == BluetoothLEAdvertisementType.SCAN_RESPONSE:</span><br><span class="line">        raw_data = _RawAdvData(raw_data.adv, event_args)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        raw_data = _RawAdvData(event_args, raw_data.scan)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>._advertisement_pairs[bdaddr] = raw_data</span><br><span class="line"></span><br><span class="line">    uuids = []</span><br><span class="line">    mfg_data = &#123;&#125;</span><br><span class="line">    service_data = &#123;&#125;</span><br><span class="line">    local_name = <span class="literal">None</span></span><br><span class="line">    tx_power = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> args <span class="keyword">in</span> <span class="built_in">filter</span>(<span class="keyword">lambda</span> d: d <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, raw_data):</span><br><span class="line">        <span class="keyword">for</span> u <span class="keyword">in</span> args.advertisement.service_uuids:</span><br><span class="line">            uuids.append(<span class="built_in">str</span>(u))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> args.advertisement.manufacturer_data:</span><br><span class="line">            mfg_data[m.company_id] = <span class="built_in">bytes</span>(m.data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># local name is empty string rather than None if not present</span></span><br><span class="line">        <span class="keyword">if</span> args.advertisement.local_name:</span><br><span class="line">            local_name = args.advertisement.local_name</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> args.transmit_power_level_in_d_bm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                tx_power = args.transmit_power_level_in_d_bm</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="comment"># the transmit_power_level_in_d_bm property was introduce in</span></span><br><span class="line">            <span class="comment"># Windows build 19041 so we have a fallback for older versions</span></span><br><span class="line">            <span class="keyword">for</span> section <span class="keyword">in</span> args.advertisement.get_sections_by_type(</span><br><span class="line">                AdvertisementDataType.TX_POWER_LEVEL</span><br><span class="line">            ):</span><br><span class="line">                tx_power = <span class="built_in">bytes</span>(section.data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decode service data</span></span><br><span class="line">        <span class="keyword">for</span> section <span class="keyword">in</span> args.advertisement.get_sections_by_type(</span><br><span class="line">            AdvertisementDataType.SERVICE_DATA_UUID16</span><br><span class="line">        ):</span><br><span class="line">            data = <span class="built_in">bytes</span>(section.data)</span><br><span class="line">            service_data[normalize_uuid_str(<span class="string">f&quot;<span class="subst">&#123;data[<span class="number">1</span>]:02x&#125;</span><span class="subst">&#123;data[<span class="number">0</span>]:02x&#125;</span>&quot;</span>)] = data[</span><br><span class="line">                <span class="number">2</span>:</span><br><span class="line">            ]</span><br><span class="line">        <span class="keyword">for</span> section <span class="keyword">in</span> args.advertisement.get_sections_by_type(</span><br><span class="line">            AdvertisementDataType.SERVICE_DATA_UUID32</span><br><span class="line">        ):</span><br><span class="line">            data = <span class="built_in">bytes</span>(section.data)</span><br><span class="line">            service_data[</span><br><span class="line">                normalize_uuid_str(</span><br><span class="line">                    <span class="string">f&quot;<span class="subst">&#123;data[<span class="number">3</span>]:02x&#125;</span><span class="subst">&#123;data[<span class="number">2</span>]:02x&#125;</span><span class="subst">&#123;data[<span class="number">1</span>]:02x&#125;</span><span class="subst">&#123;data[<span class="number">0</span>]:02x&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">            ] = data[<span class="number">4</span>:]</span><br><span class="line">        <span class="keyword">for</span> section <span class="keyword">in</span> args.advertisement.get_sections_by_type(</span><br><span class="line">            AdvertisementDataType.SERVICE_DATA_UUID128</span><br><span class="line">        ):</span><br><span class="line">            data = <span class="built_in">bytes</span>(section.data)</span><br><span class="line">            service_data[<span class="built_in">str</span>(UUID(<span class="built_in">bytes</span>=<span class="built_in">bytes</span>(data[<span class="number">15</span>::-<span class="number">1</span>])))] = data[<span class="number">16</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use the BLEDevice to populate all the fields for the advertisement data to return</span></span><br><span class="line">    advertisement_data = AdvertisementData(</span><br><span class="line">        local_name=local_name,</span><br><span class="line">        manufacturer_data=mfg_data,</span><br><span class="line">        service_data=service_data,</span><br><span class="line">        service_uuids=uuids,</span><br><span class="line">        tx_power=tx_power,</span><br><span class="line">        rssi=event_args.raw_signal_strength_in_d_bm,</span><br><span class="line">        platform_data=(sender, raw_data),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    device = <span class="variable language_">self</span>.create_or_update_device(</span><br><span class="line">        bdaddr, local_name, raw_data, advertisement_data</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>.call_detection_callbacks(device, advertisement_data)</span><br></pre></td></tr></table></figure>

<p>观察_received_handler方法的定义发现它有3个参数，self是当前调用该方法的对象，剩下两个分别是<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/uwp/api/windows.devices.bluetooth.advertisement.bluetoothleadvertisementwatcher?view=winrt-26100">BluetoothLEAdvertisementWatcher</a>对象和<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/uwp/api/windows.devices.bluetooth.advertisement.bluetoothleadvertisementreceivedeventargs?view=winrt-26100">BluetoothLEAdvertisementReceivedEventArgs</a>对象。除了self之外，另外两个参数都是Windows Runtime环境提供的对象，表明该函数是直接与Windows系统交互的。</p>
<p>在代码第15行，定义了bdaddr变量，从BluetoothLEAdvertisementReceivedEventArgs对象中取得了BLE设备地址并进行了格式化。再看第17、18行作者写的注释：不像其他的平台，Windows不会组织advertisement信息，所以我们需要自己处理。这行注释表明该方法将会处理Windows系统返回的advertisement信息。第21行到第29行尝试获取对应bdaddr地址的BLE advertisement raw，并更新本对象的_advertisement_pairs属性中bdaddr键对应的值。第31到35行创建了一些临时变量，可以发现这些变量都是Assigned Numbers对应的数据，这些变量在第83行用于创建了一个我们前面提到的AdvertisementData对象（discover方法的部分返回值）。接下来是一个嵌套的for循环，在循环中获取了BluetoothLEAdvertisementReceivedEventArgs对象内部的advertisement属性，该属性是<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/uwp/api/windows.devices.bluetooth.advertisement.bluetoothleadvertisement?view=winrt-26100">BluetoothLEAdvertisement类</a>对象，其内部构造如下</p>
<p><img src="/img/python_ble/BluetoothLEAdvertisement_class.png" alt="BluetoothLEAdvertisement类" title="BluetoothLEAdvertisement类"></p>
<p>bleak在嵌套的for循环中获取了BluetoothLEAdvertisement类内部的service_uuids，manufacturer_data，local_name属性，又通过get_sections_by_type方法获取了tx_power（发射功率），service_data，最终将填充好的变量和raw_data一起构造了一个AdvertisementData对象，随后在93行调用了create_or_update_device方法，更新了self对象属性，最后调用用户传入的回调函数</p>
<p>到这里我们可以发现，当我们在discover方法中传入return_adv&#x3D;True参数后我们其实可以拿到AdvertisementData对象，而AdvertisementData对象中platform_data属性就是在刚才_received_handler方法中传入的，platform_data是一个Tuple，其第[1]个元素就是raw_data，raw_data是一个_RawAdvData对象，_RawAdvData对象中有adv和scan属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_RawAdvData</span>(<span class="title class_ inherited__">NamedTuple</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Platform-specific advertisement data.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Windows does not combine advertising data with type SCAN_RSP with other</span></span><br><span class="line"><span class="string">    advertising data like other platforms, so se have to do it ourselves.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    adv: BluetoothLEAdvertisementReceivedEventArgs</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The advertisement data received from the BluetoothLEAdvertisementWatcher.Received event.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    scan: <span class="type">Optional</span>[BluetoothLEAdvertisementReceivedEventArgs]</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The scan response for the same device as *adv*.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>adv是BluetoothLEAdvertisementReceivedEventArgs对象，具有advertisement属性，advertisement属性是BluetoothLEAdvertisement对象，具有<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/uwp/api/windows.devices.bluetooth.advertisement.bluetoothleadvertisement.datasections?view=winrt-26100#windows-devices-bluetooth-advertisement-bluetoothleadvertisement-datasections">DataSections属性</a>，这个属性在winrt转成python对象之后变成data_sections，该属性包含了BLE设备advertisement的所有字段，我们可以直接解析这个属性，它是一个包含<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/uwp/api/windows.devices.bluetooth.advertisement.bluetoothleadvertisementdatasection?view=winrt-26100">BluetoothLEAdvertisementDataSection类</a>对象的列表，BluetoothLEAdvertisementDataSection类中有两个属性data和data_type，其中data_type就是Assigned Number，data则是Assigned Number对应的Byte内容</p>
<p>到此我们通过一个超长的对象引用链，最终拿到了我们想要的advertisement数据</p>
<h2 id="bleak获取advertisement示例"><a href="#bleak获取advertisement示例" class="headerlink" title="bleak获取advertisement示例"></a>bleak获取advertisement示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> bleak</span><br><span class="line"><span class="keyword">from</span> bleak <span class="keyword">import</span> BleakScanner</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">ble_scan</span>():</span><br><span class="line">    scanner = BleakScanner()</span><br><span class="line">    devices = <span class="keyword">await</span> scanner.discover(return_adv=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> devices:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;mac addr: <span class="subst">&#123;devices[d][<span class="number">0</span>].address&#125;</span>, name: <span class="subst">&#123;devices[d][<span class="number">0</span>].name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> args <span class="keyword">in</span> <span class="built_in">filter</span>(<span class="keyword">lambda</span> d: d <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, devices[d][<span class="number">1</span>].platform_data[<span class="number">1</span>]):</span><br><span class="line">            sec_set = []</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> args.advertisement.data_sections:</span><br><span class="line">                j_set = [<span class="built_in">int</span>(j.data_type), <span class="built_in">bytes</span>(j.data)]</span><br><span class="line">                flag = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">for</span> s <span class="keyword">in</span> sec_set:</span><br><span class="line">                    flag = (s == j_set)</span><br><span class="line">                <span class="keyword">if</span> (flag == <span class="literal">False</span>):</span><br><span class="line">                    sec_set.append(j_set)</span><br><span class="line">            <span class="keyword">for</span> sec <span class="keyword">in</span> sec_set:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Type: <span class="subst">&#123;<span class="string">&#x27;&#123;:02X&#125;&#x27;</span>.<span class="built_in">format</span>(sec[<span class="number">0</span>])&#125;</span>\tPayload: <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;%02X&#x27;</span> % b <span class="keyword">for</span> b <span class="keyword">in</span> sec[<span class="number">1</span>]])&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(ble_scan())</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">output</span></span><br><span class="line">mac addr: 81:26:00:00:07:03, name: LuYuan-Smart</span><br><span class="line">Type: 01        Payload: 06</span><br><span class="line">Type: 19        Payload: C003</span><br><span class="line">Type: 03        Payload: 1218</span><br><span class="line">Type: FF        Payload: 812600000703</span><br><span class="line">Type: 0A        Payload: 00</span><br><span class="line">Type: 09        Payload: 4C755975616E2D536D617274</span><br><span class="line">mac addr: 5A:53:C9:75:58:C7, name: None</span><br><span class="line">Type: 01        Payload: 1A</span><br><span class="line">Type: 0A        Payload: 0C</span><br><span class="line">Type: FF        Payload: 4C0010060D1D2229AB38    </span><br><span class="line">mac addr: 4D:69:42:97:E4:E4, name: None</span><br><span class="line">Type: 01        Payload: 1A</span><br><span class="line">Type: 0A        Payload: 0C</span><br><span class="line">Type: FF        Payload: 4C001005051C237DA3</span><br><span class="line">mac addr: D7:C4:BA:B5:3F:6C, name: None</span><br><span class="line">Type: FF        Payload: 4C0012020002</span><br><span class="line">mac addr: 66:84:61:36:6D:6F, name: None</span><br><span class="line">Type: 01        Payload: 1A</span><br><span class="line">Type: 0A        Payload: 0B</span><br><span class="line">Type: FF        Payload: 4C001005711C7D9A6A</span><br><span class="line">mac addr: D0:62:2C:CC:F4:0E, name: None</span><br><span class="line">Type: 01        Payload: 06</span><br><span class="line">Type: 19        Payload: C200</span><br><span class="line">Type: 16        Payload: 95FE1059282E000EF4CC2C62D0</span><br><span class="line">Type: 16        Payload: ABFD0103</span><br></pre></td></tr></table></figure>
<p>在for循环中输出了data_sections的内容，我们也可以直接将数据重新组装为raw。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>通过如上的分析，我们从bleak到Windows Runtime环境，最终获取到我们想要的数据。到此，也许如何获取advertisement RAW已经不再重要，重要的是我们了解到一条可以让python通向Windows操作系统底层的路径，该条路径以后可以帮助我们直接操作Windows的API，用以自己构建相应的python库。</p>
<p>在这里也祝贺川建国同志赢得大选，继续为世界人民带来乐子😂</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Python获取BLE广播</p><p><a href="https://cqlhupt.github.io/2024/11/06/Python获取BLE广播/">https://cqlhupt.github.io/2024/11/06/Python获取BLE广播/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>John Tony</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-11-06</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-11-09</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/11/09/AHB%E5%AD%A6%E4%B9%A0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">AHB学习</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/11/03/ESP-IDF%E5%BB%BA%E7%AB%8BArduino%E7%BB%84%E4%BB%B6%E9%A1%B9%E7%9B%AE/"><span class="level-item">ESP-IDF建立Arduino组件项目</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="cqlhupt/cqlhupt.github.io" issue-term="pathname" label="some-issue-label" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/xuancailizi.jpg" alt="Jhon Tony"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Jhon Tony</p><p class="is-size-6 is-block">Jhon Tony&#039;s Blog</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Galaxy, Universe</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqlhupt" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqlhupt"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-09T10:53:17.000Z">2024-11-09</time></p><p class="title"><a href="/2024/11/09/AHB%E5%AD%A6%E4%B9%A0/">AHB学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-06T13:10:28.000Z">2024-11-06</time></p><p class="title"><a href="/2024/11/06/Python%E8%8E%B7%E5%8F%96BLE%E5%B9%BF%E6%92%AD/">Python获取BLE广播</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-03T04:27:01.000Z">2024-11-03</time></p><p class="title"><a href="/2024/11/03/ESP-IDF%E5%BB%BA%E7%AB%8BArduino%E7%BB%84%E4%BB%B6%E9%A1%B9%E7%9B%AE/">ESP-IDF建立Arduino组件项目</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-03T01:45:40.000Z">2024-11-03</time></p><p class="title"><a href="/2024/11/03/Hexo%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%8C%87%E5%8D%97/">Hexo博客迁移问题解决指南</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-01T09:40:56.000Z">2024-11-01</time></p><p class="title"><a href="/2024/11/01/ESP-IDF-environment-setup/">ESP-IDF环境搭建</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/11/"><span class="level-start"><span class="level-item">十一月 2024</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2024 John Tony</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>