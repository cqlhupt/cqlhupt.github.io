---
title: APB总线学习
top: true
date: 2022-08-10 20:52:25
---
这篇文章是APB总线学习的记录，说是记录其实是总线规范的翻译。APB总线是一个非流水线、低带宽、低复杂度的优化接口，用于挂载SoC内部的低速外设，如今广泛应用于各种SoC之中，是AMBA总线家族的一份子。AMBA总线是ARM公司推出的一系列用于搭建以ARM处理器为基础的SoC内部总线，由于如今嵌入式、移动端ARM处理器占比巨大，所以AMBA总线的占比也非常大。不过AMBA总线是公开的标准，不收取任何授权费用，所以也得到业内的广泛认可。
<!--more-->

# 概述
* 一个低功耗、低复杂度的改良接口
* 低带宽、非流水线接口，不要求设备具有流水线接口
* 所有信号的变化都在上升沿，便于集成，每次传输至少两个周期
* 可配合AHB、AXI使用，可用于配置外设（好像系统中的设备都是通过APB配置，而不会用AXI、AHB配置？）

# 信号定义
| 名称    | 来源         | 描述                                                                                          |
| ------- | ------------ | --------------------------------------------------------------------------------------------- |
| PCLK    | 时钟源       | 时钟，上升沿用于APB的所有传输                                                                 |
| PRESETn | 系统总线复位 | 复位，低电平有效，通常直接接到系统总线复位信号                                                |
| PADDR   | APB桥        | 地址，APB地址总线，最多可以达到32位，由外设总线桥驱动                                         |
| PSELx   | APB桥        | 选择，APB桥生成该信号用于不同的从机，当传输到来时表示从机的选中，每个从机都有一个，且互相排斥 |
| PENABLE | APB桥        | 使能，用于指示APB传输的第二个周期                                                             |
| PWRITE  | APB桥        | 方向，高表示写，低表示读                                                                      |
| PWDATA  | APB桥        | 写数据，由APB桥在PWRITE信号为高时驱动，可以达到32位                                           |
| PREADY  | 从机         | 就绪，从机用来扩展传输周期                                                                    |
| PRDATA  | 从机         | 读数据，由APB桥在PWRITE信号为低时驱动，可以达到32位                                           |
| PSLVERR | 从机         | 表示传输失败，不是必要信号，当从机没有时，主机的该信号接地                                    |

# 写传输
## 一、没有等待的写
![无等待写](/img/APB/APB%E6%97%A0%E7%AD%89%E5%BE%85%E5%86%99.png "无等待写")

传输由地址、写信号（拉高表示写）、片选信号、数据同时改变的时钟上升沿开始，该阶段称为建立阶段。下一个时钟沿使能信号生效，表示进入访问阶段。地址、写信号、片选信号、数据要保持到访问阶段结束。访问阶段结束意味着传输完成。
使能信号在访问阶段结束时失效。片选信号也应当拉低，除非接下来的传输依然是给相同的外设。

## 二、有等待的写
![有等待写](/img/APB/APB%E6%9C%89%E7%AD%89%E5%BE%85%E5%86%99.png "有等待写")
唯一的区别在于，当使能信号拉高后，外设通过拉低就绪（PREADY）信号扩展了访问阶段，延迟了传输的周期。在就绪信号为低时，所有的其他信号要保持不变。

**当一次传输结束时推荐不要改变地址和写信号，保持到下一次传输到来时，这样可以降低（开关）功耗。**

# 读传输
## 一、无等待的读
![无等待读](/img/APB/APB%E6%97%A0%E7%AD%89%E5%BE%85%E8%AF%BB.png "无等待读")

主机将地址放在地址线上，将写信号拉低表示读、拉高片选信号，过一个周期之后拉高使能信号，同时从机将数据放在PRDATA线上并拉高PREADY表示数据就绪。

## 二、有等待的读
![有等待的读](/img/APB/APB%E6%9C%89%E7%AD%89%E5%BE%85%E8%AF%BB.png "有等待的读")
同样，如果从机未准备好，那么可以拉低PREADY表示未就绪，使主机保持现有的信号直到从机就绪。

# 错误响应

可以使用PSLVERR信号表示传输中的错误状况，读写都可以使用。

PSLVERR只在传输的最后阶段（PSEL, PENABLE, PREADY都为高）时才被考虑生效。

推荐（非强制）在传输的最后阶段前PSLVERR都保持低状态。

传输收到错误时，改不改变外设的状态取决于从机，且改不改变都是可以被协议接受的。写传输中出现错误不代表数据没被写进外设，读传输出错时可以返回不可用的数据，没有要求必须返回全0.

对于已存在或者新的APB外设都没有强制要求支持PSLVERR信号。当从机没有该信号时，APB桥（主机）的该引脚接到地即可。

![写传输错误](/img/APB/%E5%86%99%E4%BC%A0%E8%BE%93%E9%94%99%E8%AF%AF.png "写传输错误")

![读传输错误](/img/APB/%E8%AF%BB%E4%BC%A0%E8%BE%93%E9%94%99%E8%AF%AF.png "读传输错误")

## 错误向上映射
* AXI2APB：APB错误映射为**RRESP/BRESP=SLVERR**，即将PSLVERR信号映射为RRESP\[1\]（读）和BRESP\[1\]（写）
* AHB2APB：APB错误映射为**HRESP=ERROR**，即将PSLVERR信号映射为HRESP\[0\]（读或写）

# 传输操作状态
![传输操作状态转移图](/img/APB/%E4%BC%A0%E8%BE%93%E6%93%8D%E4%BD%9C%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB%E5%9B%BE.png "传输操作状态转移图")

| 状态   | 描述                                                                                                                                                                                                                  |
| ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| IDLE   | 空闲状态                                                                                                                                                                                                              |
| SETUP  | 当选择信号PSELx生效时，总线进入SETUP状态。总线只在该状态一个周期，下一个始终沿到来时进入ACCESS状态                                                                                                                    |
| ACCESS | 使能信号PENABLE在该状态拉高，其他信号在SETUP变为ACCESS时必须保持稳定。ACCESS状态的退出收到从机的PREADY控制。当PREADY拉低时保持在ACCESS，当PREADY拉高后如果没有紧接着的传输就进入IDLE，否则直接进入SETUP开始下一次传输 |
